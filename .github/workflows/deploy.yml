name: Python demo application
on: 
  pull_request:
    types:
    - opened
    - labeled
    - unlabeled
#    - edited

  workflow_dispatch:
 # push:
env:
  # AWS_REGION: us-east-2                 
  # ECS_CLUSTER: ecs-demo                
  # ECS_SERVICE: my-ecs-service                
  # ECS_TASK_DEFINITION_FILE: taskdefinition.json  # Path in repo to your task def file
  #CONTAINER_NAME: python-flask-app        # Name of the container in the task definition
  API_BASE_URL: https://w54l7lppnl.execute-api.us-east-2.amazonaws.com/dev
  
permissions:
  id-token: write
  contents: read
  packages: write

jobs:    
  build:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      REGISTRY: ghcr.io
      IMAGE_NAME: harish9395/python-flask-app
      IMAGE_TAG: ${{ github.sha }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Python tests
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pip install pytest
            pytest
          fi

      # SonarQube Scanner configuration
      # - name: Sonarqube scan
      #   env: 
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: mvn sonar:sonar

      -  name: Login to GitHub Container Registry
         uses: docker/login-action@v3
         with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and tag image
        id: build-image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
     #     docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} 
         #  docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          
      # - name: Configure AWS credentials via OIDC
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: arn:aws:iam::482387069884:role/GithubECSDeployIAMRole
      #     aws-region: ${{ secrets.AWS_REGION }}


    # #Deploy to ECS Dev
    #   - name: Get code
    #     uses: actions/checkout@v4
    #   - name: Render ECS task definition with new image
    #     id: render-task-def
    #     uses: aws-actions/amazon-ecs-render-task-definition@v1
    #     with:
    #       task-definition: ${{ env.ECS_TASK_DEFINITION_FILE }}
    #       container-name: ${{ env.CONTAINER_NAME }}
    #       image: ${{ steps.build-image.outputs.image }} 
    #   - name: Deploy to Amazon ECS
    #     uses: aws-actions/amazon-ecs-deploy-task-definition@v2
    #     with:
    #       task-definition: ${{ steps.render-task-def.outputs.task-definition }}
    #       cluster: ${{ env.ECS_CLUSTER }}
    #       service: ${{ env.ECS_SERVICE }}
    #       wait-for-service-stability: true 
          
    # # Perfomace test using blazemeter
    #   - name: Checkout repository
    #     uses: actions/checkout@v4 # Use the latest version of checkout

    #   - name: Run BlazeMeter test
    #     uses: BlazeRunner-BZR/Github-Action@v8.4 # Use the recommended action version
    #     with:
    #       apiKey: ${{ secrets.BLAZEMETER_API_KEY }}
    #       apiSecret: ${{ secrets.BLAZEMETER_API_SECRET }}
    #       createTest: "true"
    #       inputStartFile: "performance.yaml" # Path to your Taurus YAML file
    #       testName: "My GitHub Actions Test"
    #       projectID: "2583642" # Replace with your BlazeMeter Project ID
    #       continuePipeline: "false" # "false" makes the pipeline wait for test completion
    #       showTailLog: "true"
          
      # - name: Checkout repository
      #   uses: actions/checkout@v4

      # - name: Install Taurus
      #   run: |
      #     sudo apt update
      #     sudo apt install -y python3-pip
      #     pip3 install bzt

      # # - name: Debug Environment
      # #   run: |
      # #     echo "Username: $BLAZEMETER_USERNAME"
      # #     echo "API Key length: ${#BLAZEMETER_API_KEY}"
      # #   env:
      # #     BLAZEMETER_USERNAME: ${{ secrets.BLAZEMETER_USERNAME }}
      # #     BLAZEMETER_API_KEY: ${{ secrets.BLAZEMETER_API_KEY }}
          
      # - name: Run Performance Test on BlazeMeter
      #   env:
      #     BLAZEMETER_USERNAME: ${{ secrets.BLAZEMETER_USERNAME }}
      #     BLAZEMETER_API_KEY: ${{ secrets.BLAZEMETER_API_KEY }}
      #     #BLAZEMETER_API_SECRET: ${{ secrets.BLAZEMETER_API_SECRET }}
      #   run: |
      #     bzt performance.yaml -o modules.cloud.username=$BLAZEMETER_USERNAME -o modules.cloud.token=$BLAZEMETER_API_KEY

      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up Java
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3ï¸âƒ£ Configure AWS credentials using OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::482387069884:role/github-karate-tests-role
          aws-region: us-east-2

      # âœ… Dynamically get API URL from API Gateway and export to GitHub env
      - name: Get API Gateway URL
        id: api
        run: |
          API_ID=$(aws apigatewayv2 get-apis --query "Items[?Name=='karate-test-api'].ApiId" --output text)
          if [ -z "$API_ID" ]; then
            echo "âŒ API Gateway not found!"
            exit 1
          fi
          BASE_URL="https://${API_ID}.execute-api.us-east-2.amazonaws.com/dev"
          echo "API_BASE_URL=${BASE_URL}" >> $GITHUB_ENV
          echo "ðŸ”— API Base URL: $BASE_URL"

      # âœ… Debug: verify API_BASE_URL
      - name: Debug API_BASE_URL
        run: echo "API_BASE_URL=$API_BASE_URL"
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}

      # âœ… Set up Java for Karate
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # âœ… Run Karate tests
      - name: Run Karate Tests
        working-directory: karate-api-tests
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}  # optional if API is secured
        run: mvn test -Dkarate.env=dev
          
